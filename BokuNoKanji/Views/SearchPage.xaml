<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="BokuNoKanji.Views.SearchPage"
             Title="Search Kanji">

    <!-- Remove the BindingContext from XAML since we'll set it in code-behind -->

    <VerticalStackLayout Padding="20" Spacing="20">
        <!-- Search Bar -->
        <SearchBar Placeholder="Search by character, meaning, or stroke count..."
                   Text="{Binding SearchText, Mode=TwoWay}" 
                   SearchButtonPressed="SearchBar_SearchButtonPressed"
                   x:Name="KanjiSearchBar"/>

        <!-- Quick Search Tips -->
        <Border BackgroundColor="{AppThemeBinding Light=#F0F8FF, Dark=#1E3A5F}" 
               Padding="15" x:Name="TipsBorder">
            <VerticalStackLayout Spacing="10">
                <Label Text="Search Tips:" FontAttributes="Bold" />
                <Label Text="• Type a kanji character (e.g., 人)" />
                <Label Text="• Type an English meaning (e.g., person)" />
                <Label Text="• Type a stroke count number (e.g., 2)" />
                <Label Text="• An empty search bar displays random kanjis" />
            </VerticalStackLayout>
        </Border>

        <HorizontalStackLayout Spacing="10">
            
            <Label Text="Max Displayed Kanjis:" VerticalOptions="Center" FontSize="Micro"/>
            
            <Picker x:Name="picker"
                    SelectedIndex="{Binding SelectedLimitIndex, Mode=TwoWay}">
                <Picker.ItemsSource>
                    <x:Array Type="{x:Type x:String}">
                        <x:String>50 results</x:String>
                        <x:String>100 results</x:String>
                        <x:String>200 results</x:String>
                        <x:String>500 results</x:String>
                        <x:String>All results</x:String>
                    </x:Array>
                </Picker.ItemsSource>
            </Picker>
        </HorizontalStackLayout>

        <HorizontalStackLayout Spacing="5" HorizontalOptions="Center">
            <CheckBox IsChecked="False"
                      VerticalOptions="Center"
                      CheckedChanged="CheckBox_CheckedChanged"/>

            <Label Text="Advanced Search" VerticalOptions="Center" FontSize="Micro"/>

            <Button Text="?" 
                    x:Name="HelpButton"
                    FontSize="12"
                    WidthRequest="24"
                    HeightRequest="24"
                    Clicked="HelpButton_Clicked"/>   
            
        </HorizontalStackLayout>

        <VerticalStackLayout Padding="20" x:Name="AdvancedSearchSub" IsVisible="False">

            <!-- Conditions -->
            <CollectionView ItemsSource="{Binding Source={x:Reference AdvancedSearchSub}, Path=BindingContext.Conditions}"
                            HeightRequest="300">
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Grid ColumnDefinitions="*,*,Auto" Padding="5" ColumnSpacing="5"
                              RowDefinitions="*,*,*" RowSpacing="5">

                            <!-- Field -->
                            <Picker Grid.Column="0" Grid.Row="0"
                            Title="Field" x:Name="FieldPicker"
                            ItemsSource="{Binding Source={x:Reference AdvancedSearchSub}, Path=BindingContext.AvailableFields}"
                            SelectedItem="{Binding Field}"
                            VerticalOptions="Center"/>

                            <!-- Operator -->
                            <Picker Grid.Column="1" Grid.Row="0"
                            Title="Operator" x:Name="OperatorPicker"
                            ItemsSource="{Binding Source={x:Reference AdvancedSearchSub}, Path=BindingContext.AvailableOperators}"
                            SelectedItem="{Binding Operator}" 
                            VerticalOptions="Center"/>

                            <!-- Value -->
                            <Entry Grid.Column="0" Grid.Row="1"
                           Placeholder="Value"
                           Text="{Binding Value}" 
                            VerticalOptions="Center"/>

                            <!-- Logical -->
                            <Picker Grid.Column="1" Grid.Row="1"
                            Title="Logic Operator"
                            ItemsSource="{Binding Source={x:Reference AdvancedSearchSub}, Path=BindingContext.AvailableLogical}"
                            SelectedItem="{Binding Logical}" 
                            VerticalOptions="Center"/>

                            <!-- Remove button -->
                            <Button Grid.Column="2" Grid.Row="0" Grid.RowSpan="2"
                            Text="X"
                            Command="{Binding Source={x:Reference AdvancedSearchSub}, Path=BindingContext.RemoveConditionCommand}"
                            CommandParameter="{Binding .}" 
                            VerticalOptions="Center"/>

                            <Border BackgroundColor="{AppThemeBinding Light=#F0F8FF, Dark=#1E3A5F}"
                                    Grid.Row="2" Grid.ColumnSpan="3"
                                    Margin="5"/>

                        </Grid>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <!-- Add + Search buttons -->
            <HorizontalStackLayout Spacing="10" Margin="0,10,0,0">
                <Button Text="Add Condition"
                Command="{Binding AddConditionCommand}" />
                <Button Text="Search"
                Command="{Binding ExecuteSearchCommand}" />
            </HorizontalStackLayout>

        </VerticalStackLayout>


    </VerticalStackLayout>
</ContentPage>